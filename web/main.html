<!DOCTYPE html>
<html>
    <head>
        <title>KB Utils</title>
        <link rel="stylesheet" href="main.css"/>
        <link rel="stylesheet" href="gridjs-dark.css"/>

        <!-- Include eel.js - note this file doesn't exist in the 'web' directory -->
        <script type="text/javascript" src="/eel.js"></script>
        <script type="text/javascript" src="utils.js"></script>
        <script type="text/javascript" src="gridjs.production.min.js"></script>
        <script type="text/javascript">
            window.onload = function() { loadParams(true); }
            window.onbeforeunload = function() { saveParams(true); }
            var initialized = false;

            async function saveParams(closing=false) {
                if (!initialized) return;
                var x = getParams();
                x = await eel.saveParams(x, closing);
            }
            
            async function loadParams(first=false) {
                x = await eel.loadParams()();
                setParams(x);
                makeTextList();
                initialized = true;
            }
            
            async function reload() {
                x = await saveParams();
                x = await loadParams();
            }

            function makeTextList() {
                x = txtListEdit.value;
                s = "";
                //alert(x);
                a = x.split("\n");
                a.forEach(e => {
                    if (!e.startsWith("#"))
                        s += "<a href='#' onclick='eel.sendText(this.innerHTML)'>" + e + "</a><br>\n";
                });
                divTextList.innerHTML = s;
            }

            eel.expose(text2Link)
            function text2Link(t) {
                x = txtListEdit.value;
                s = "";
                //alert(x);
                a = t.split("\n");
                a.forEach(x => {
                    x = x.replace("\r", "");
                    x = x.replace("\n", "");
                    x = x.replace("\t", " ");
                    s += "<a href='#' onclick='eel.copy(\"" + x + "\")'>" + x + "</a><br>\n";
                });
                divLinks.innerHTML = s;
            }

            eel.expose(setInnerHtml)
            function setInnerHtml(id, s) {
                //alert(s);
                e(id).innerHTML = s;
            }

            var clips;
            var grid;

            eel.expose(clipmonInit)
            function clipmonInit(data) {
                clips = data;
                prl(clips);
                grid = new gridjs.Grid({
                    columns: [
                        { id: 'name', name: 'Name' }, 
                        { id: 'size', name: 'Size' }, 
                        { id: 'time', name: 'Time' },
                        { id: 'data', name: 'Text', hidden: true }],
                    resizable: true,
                    sort: true,
                    search: false,
                    data: clips,
                    className: {
                        th: 'clipmon-th',
                        td: 'clipmon-td',
                        table: 'clipmon-table'
                    }
                });
                grid.render(e("divCliplist"));
            }

            function resizeElement(e, bottom=0) {
                e.style.height = (window.innerHeight - e.offsetTop - 2 * e.offsetLeft - bottom) + "px";
            }

            function resize() {
                resizeElement(txta);
                resizeElement(divTextList);
                resizeElement(divCliplist, divCliptext.offsetHeight);
                resizeElement(divLinks);
            }
            
            function selTab(evt, tabName) {
                selectTab(evt, tabName);
                resize();
                saveParams();
                makeTextList();
            } 
        </script>
    </head>

    <body id="body" style="overflow:hidden;" onresize="resize()">
        <style>
        </style>
        <div class="tab">
            <button class="tablinks" id="defaultTab" onclick="selTab(event, 'divClipmon')">ClipMon</button>
            <button class="tablinks" onclick="selTab(event, 'divPrefixFile')">PrefixFile</button>
            <button class="tablinks" onclick="selTab(event, 'divText2Link')">Text2Link</button>
            <button class="tablinks" onclick="selTab(event, 'divInfo')">Info</button>
        </div>
        <hr style="margin-top:0px;">
        
        <div id="divPrefixFile" class="tabcontent">
            <input type="button" class="btn" value="Macro1" onclick="eel.sendMacro('Marco1')">
            <input type="checkbox" save="checked" id="chkPostfix" onclick="saveParams()">Postfix
            <image class="img right" title="options" onclick="dlgTextList.showModal()" src="settings2w.png" />
            <br />
            <input type="button" class="btn" value="Macro2" onclick="eel.sendMacro('Marco2')">
            <input type="checkbox" save="checked" id="chkDash" onclick="saveParams()">Dash
            <br />
            <input type="button" class="btn" value="Clipboard" onclick="eel.sendText('clipboard')">
            <input type="checkbox" save="checked" id="chkPotpl" onclick="saveParams()">PotPlayer
            <hr>
            <div id="divTextList" style="overflow:auto">
            </div>
        </div>
        <dialog id="dlgTextList">
            TextList:<br/><textarea id="txtListEdit" rows="12" save="value"></textarea><br><br>
            <button onclick="dlgTextList.close(); reload();">Close</button>
        </dialog>
        
        <div id="divText2Link" class="tabcontent">
            <input type="button" class="btn" value="FromClipb" onclick="eel.doCmd('FromClipb')">
            <input type="button" class="btn" value="CopyAll" onclick="eel.doCmd('CopyAll')">
            <div id="divLinks" style="overflow:auto">
            </div>
        </div>
        
        <div id="divClipmon" class="tabcontent" >
            <div id="divCliplist" class="gridjs-wrapper" style="overflow-x:hidden"></div>
            <div id="divCliptext" style="margin-top:8px">Text:<textarea id="txtCliptext" rows="8"></textarea></div>
        </div>
        
        <div id="divInfo" class="tabcontent" >
            <div class="divText">Info:<br/><textarea id="txta"></textarea></div>
        </div>
    </body>
    <script>
        document.getElementById("defaultTab").click();
        clipmonInit(eel.getClips());
        resize();
    </script>
</html>
